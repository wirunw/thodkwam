<!DOCTYPE html>
<html lang=\"th\">
<head>
    <meta charset=\"UTF-8\">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>ถอดความ</title>
    <script src=\"https://cdn.tailwindcss.com\"></script>
    <link href=\"https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap\" rel=\"stylesheet\">
    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .glowing-dot {
            width: 12px; height: 12px; background-color: #f87171; border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(248, 113, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0); }
        }
    </style>
</head>
<body class=\"bg-gray-100 min-h-screen flex flex-col\">

    <div class=\"w-full bg-white shadow-lg p-6 md:p-8 space-y-8 flex-grow\">
        
        <header class=\"text-center max-w-4xl mx-auto\">
            <img src=\"https://i.postimg.cc/dDfBQVWf/wirun-facbook.png\" alt=\"Logo ถอดความ\" class=\"mx-auto mb-4 w-24 h-24 rounded-full shadow-md object-cover\">
            <h1 class=\"text-3xl md:text-4xl font-bold text-gray-800\">ถอดความ</h1>
            <p class=\"text-gray-600 mt-2\">เปลี่ยนเสียงพูดของคุณให้เป็นข้อความ และเปลี่ยนข้อความให้กลายเป็นเสียงพูดได้อย่างง่ายดายและรวดเร็ว</p>
        </header>

        <div id=\"unsupported-message\" class=\"hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg max-w-4xl mx-auto\" role=\"alert\">
            <p class=\"font-bold\">ขออภัย!</p>
            <p>เบราว์เซอร์ของคุณไม่รองรับ Web Speech API โปรดลองใช้ Google Chrome หรือ Microsoft Edge เวอร์ชันล่าสุด</p>
        </div>

        <main id=\"app-container\" class=\"max-w-4xl mx-auto w-full\">

            <!-- Selection View -->
            <div id=\"selection-view\">
                <h2 class=\"text-2xl font-bold text-gray-700 mb-6 text-center\">กรุณาเลือกบริการที่ต้องการ</h2>
                <div class=\"grid grid-cols-1 md:grid-cols-2 gap-6\">
                    <button id=\"select-stt-button\" class=\"bg-gray-50 p-8 rounded-2xl border border-gray-200 text-center flex flex-col items-center justify-center h-full transition-all duration-300 ease-in-out hover:shadow-2xl hover:transform hover:-translate-y-2 hover:border-blue-500\">
                        <i class=\"fas fa-microphone text-green-500 text-4xl mb-4\"></i>
                        <h3 class=\"text-xl font-bold text-gray-800\">แปลงเสียงพูดเป็นข้อความ</h3>
                        <p class=\"text-gray-500 mt-1\">ถอดเสียงจากไมโครโฟนเป็นตัวอักษร</p>
                    </button>
                    <button id=\"select-tts-button\" class=\"bg-gray-50 p-8 rounded-2xl border border-gray-200 text-center flex flex-col items-center justify-center h-full transition-all duration-300 ease-in-out hover:shadow-2xl hover:transform hover:-translate-y-2 hover:border-blue-500\">
                        <i class=\"fas fa-volume-high text-blue-500 text-4xl mb-4\"></i>
                        <h3 class=\"text-xl font-bold text-gray-800\">แปลงข้อความเป็นเสียงพูด</h3>
                        <p class=\"text-gray-500 mt-1\">ให้ระบบอ่านข้อความที่คุณพิมพ์</p>
                    </button>
                </div>
            </div>

            <!-- Speech-to-Text View -->
            <div id=\"stt-view\" class=\"hidden\">
                 <button class=\"back-button mb-6 text-blue-600 hover:underline flex items-center gap-2\">
                    <i class=\"fas fa-arrow-left\"></i> กลับหน้าหลัก
                </button>
                <div class=\"bg-gray-50 p-6 rounded-xl border border-gray-200 flex flex-col\">
                    <h2 class=\"text-2xl font-bold text-gray-700 mb-4\">แปลงเสียงพูดเป็นข้อความ</h2>
                    
                    <div class=\"mb-4\">
                        <label for=\"lang-select\" class=\"block text-sm font-medium text-gray-700 mb-1\">เลือกภาษาที่พูด:</label>
                        <select id=\"lang-select\" class=\"w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition\">
                            <option value=\"th-TH\" selected>ภาษาไทย</option>
                            <option value=\"en-US\">English (US)</option>
                            <option value=\"en-GB\">English (UK)</option>
                            <option value=\"ja-JP\">日本語 (ญี่ปุ่น)</option>
                            <option value=\"ar-SA\">العربية (อาหรับ)</option>
                            <option value=\"ms-MY\">Bahasa Melayu (มาเลย์)</option>
                            <option value=\"my-MM\">မြန်မာ (พม่า)</option>
                            <option value=\"hi-IN\">हिन्दी (อินเดีย)</option>
                        </select>
                    </div>

                    <textarea id=\"transcript\" class=\"w-full h-40 p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500\" placeholder=\"ข้อความที่ถอดเสียงจะปรากฏที่นี่...\"></textarea>
                    
                    <div class=\"grid grid-cols-2 md:grid-cols-3 gap-3 mb-4\">
                        <button id=\"listen-button\" class=\"bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-md flex items-center justify-center gap-2\"><i class=\"fas fa-microphone\"></i><span id=\"listen-text\">เริ่มฟัง</span></button>
                        <button id=\"copy-button\" class=\"bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2\"><i class=\"fas fa-copy\"></i><span>คัดลอก</span></button>
                        <button id=\"save-segment-button\" class=\"bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition flex items-center justify-center gap-2\"><i class=\"fas fa-bookmark\"></i><span>บันทึกช่วง</span></button>
                        <button id=\"save-button\" class=\"bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition flex items-center justify-center gap-2\"><i class=\"fas fa-save\"></i><span>บันทึกไฟล์</span></button>
                        <button id=\"clear-button\" class=\"bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition flex items-center justify-center gap-2\"><i class=\"fas fa-trash\"></i><span>ล้างข้อความ</span></button>
                        <button id=\"copy-all-segments-button\" class=\"bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2\"><i class=\"fas fa-paste\"></i><span>คัดลอกทุกช่วง</span></button>
                    </div>
                    
                    <div id=\"listening-indicator\" class=\"hidden flex items-center justify-center gap-2 mb-4 text-red-500\"><div class=\"glowing-dot\"></div><span>กำลังฟัง...</span></div>
                    
                    <h3 class=\"text-lg font-bold text-gray-700 mb-2\">ช่วงที่บันทึกไว้:</h3>
                    <div id=\"segments-list\" class=\"space-y-3 bg-white p-3 rounded-lg border border-gray-200 min-h-[150px] max-h-72 overflow-y-auto\">
                         <!-- Saved segments appear here -->
                    </div>
                </div>
            </div>

            <!-- Text-to-Speech View -->
            <div id=\"tts-view\" class=\"hidden\">
                 <button class=\"back-button mb-6 text-blue-600 hover:underline flex items-center gap-2\">
                    <i class=\"fas fa-arrow-left\"></i> กลับหน้าหลัก
                </button>
                <div class=\"bg-gray-50 p-6 rounded-xl border border-gray-200\">
                    <h2 class=\"text-2xl font-bold text-gray-700 mb-4\">แปลงข้อความเป็นเสียงพูด</h2>
                     <div class=\"space-y-4\">
                        <div>
                            <label for=\"text-to-speak\" class=\"block text-sm font-medium text-gray-700 mb-1\">ใส่ข้อความที่นี่:</label>
                            <textarea id=\"text-to-speak\" rows=\"8\" class=\"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition\" placeholder=\"พิมพ์ข้อความ...\"></textarea>
                        </div>
                        <div>
                            <label for=\"voice-select\" class=\"block text-sm font-medium text-gray-700 mb-1\">เลือกเสียง:</label>
                            <select id=\"voice-select\" class=\"w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition\"></select>
                        </div>
                        <div class=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">
                            <div>
                                <label for=\"rate\" class=\"block text-sm font-medium text-gray-700\">ความเร็ว: <span id=\"rate-value\" class=\"font-bold\">1</span></label>
                                <input type=\"range\" id=\"rate\" min=\"0.1\" max=\"2\" value=\"1\" step=\"0.1\" class=\"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer\">
                            </div>
                            <div>
                                <label for=\"pitch\" class=\"block text-sm font-medium text-gray-700\">ระดับเสียง: <span id=\"pitch-value\" class=\"font-bold\">1</span></label>
                                <input type=\"range\" id=\"pitch\" min=\"0\" max=\"2\" value=\"1\" step=\"0.1\" class=\"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer\">
                            </div>
                        </div>
                        <div class=\"flex items-center gap-4\">
                            <button id=\"speak-button\" class=\"w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-md\">พูด</button>
                            <button id=\"stop-button\" class=\"w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors shadow-md\">หยุด</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        
        <!-- How to Use Section -->
        <div id=\"how-to-use\" class=\"max-w-4xl mx-auto mt-8\">
            <div class=\"bg-white rounded-2xl p-6 md:p-8\">
                <h3 class=\"text-2xl font-bold text-gray-800 mb-6 text-center flex items-center justify-center gap-3\">
                    <i class=\"fas fa-question-circle text-blue-500\"></i>
                    วิธีการใช้งาน
                </h3>
                <div class=\"grid grid-cols-1 md:grid-cols-2 gap-6\">
                    <div class=\"bg-gray-50 p-5 rounded-xl border border-green-200\">
                        <h4 class=\"font-semibold text-lg text-gray-800 flex items-center gap-2 mb-2\"><i class=\"fas fa-microphone text-green-600\"></i>แปลงเสียงพูดเป็นข้อความ</h4>
                        <ol class=\"list-decimal list-inside space-y-1 text-gray-700\">
                            <li>เลือกภาษาที่ต้องการพูด</li>
                            <li>กด 'เริ่มฟัง' แล้วพูดใส่ไมโครโฟน</li>
                            <li>ข้อความจะปรากฏในกล่องหลัก</li>
                            <li>กด 'บันทึกช่วง' เพื่อเก็บข้อความไว้</li>
                            <li>ใช้ปุ่มต่างๆ เพื่อคัดลอก บันทึก หรือล้างข้อความ</li>
                        </ol>
                    </div>
                    <div class=\"bg-gray-50 p-5 rounded-xl border border-blue-200\">
                        <h4 class=\"font-semibold text-lg text-gray-800 flex items-center gap-2 mb-2\"><i class=\"fas fa-font text-blue-600\"></i>แปลงข้อความเป็นเสียงพูด</h4>
                        <ol class=\"list-decimal list-inside space-y-1 text-gray-700\">
                            <li>พิมพ์ข้อความที่ต้องการในกล่อง</li>
                            <li>เลือกเสียงพูดที่ชอบจากตัวเลือก</li>
                            <li>ปรับความเร็วและระดับเสียง</li>
                            <li>กด 'พูด' เพื่อฟังเสียง</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <footer class=\"text-center text-gray-600 text-sm py-6\">
        <p>ออกแบบโดยเภสัชกรวิรุณ เวชศิริ</p>
         <div class=\"flex justify-center items-center gap-4 mt-2\">
            <a href=\"https://www.pharmconnection.net\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"hover:text-blue-600 transition-colors flex items-center gap-1\">
                <i class=\"fas fa-globe\"></i>www.pharmconnection.net
            </a>
            <a href=\"https://www.linkedin.com/in/wirunw/\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"hover:text-blue-600 transition-colors flex items-center gap-1\">
                <i class=\"fab fa-linkedin\"></i>LinkedIn Profile
            </a>
         </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const synth = window.speechSynthesis;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!synth || !SpeechRecognition) {
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('unsupported-message').classList.remove('hidden');
                return;
            }

            // --- Clipboard Fallback Function ---
            function copyTextToClipboard(text, button) {
                const textArea = document.createElement(\"textarea\");
                textArea.value = text;
                textArea.style.position = \"fixed\";  
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    if (button) {
                        const originalText = button.innerHTML;
                        button.innerHTML = 'คัดลอกแล้ว!';
                        setTimeout(() => { button.innerHTML = originalText; }, 2000);
                    }
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }
                document.body.removeChild(textArea);
            }

            // --- View Management ---
            const selectionView = document.getElementById('selection-view');
            const sttView = document.getElementById('stt-view');
            const ttsView = document.getElementById('tts-view');
            const howToUseSection = document.getElementById('how-to-use');
            const selectSttButton = document.getElementById('select-stt-button');
            const selectTtsButton = document.getElementById('select-tts-button');
            const backButtons = document.querySelectorAll('.back-button');

            function showView(viewToShow) {
                [selectionView, sttView, ttsView].forEach(v => v.classList.add('hidden'));
                viewToShow.classList.remove('hidden');
                howToUseSection.classList.toggle('hidden', viewToShow !== selectionView);
            }
            selectSttButton.addEventListener('click', () => showView(sttView));
            selectTtsButton.addEventListener('click', () => showView(ttsView));
            backButtons.forEach(button => button.addEventListener('click', () => {
                if (synth.speaking) synth.cancel();
                if (isListening) {
                    isListening = false;
                    recognition.stop();
                }
                showView(selectionView);
            }));

            // --- TEXT-TO-SPEECH ---
            const textToSpeakInput = document.getElementById('text-to-speak');
            const voiceSelect = document.getElementById('voice-select');
            const rateInput = document.getElementById('rate');
            const rateValue = document.getElementById('rate-value');
            const pitchInput = document.getElementById('pitch');
            const pitchValue = document.getElementById('pitch-value');
            const speakButton = document.getElementById('speak-button');
            const stopButton = document.getElementById('stop-button');
            let voices = [];
            const utterance = new SpeechSynthesisUtterance();

            function populateVoiceList() {
                voices = synth.getVoices();
                voiceSelect.innerHTML = '';
                const thaiVoices = voices.filter(v => v.lang.includes('th'));
                const otherVoices = voices.filter(v => !v.lang.includes('th'));
                const createOptGroup = (label, list) => {
                    if (list.length > 0) {
                        const group = document.createElement('optgroup');
                        group.label = label;
                        list.forEach(voice => {
                            const option = document.createElement('option');
                            option.textContent = `${voice.name} (${voice.lang})`;
                            option.setAttribute('data-name', voice.name);
                            group.appendChild(option);
                        });
                        voiceSelect.appendChild(group);
                    }
                };
                createOptGroup('เสียงภาษาไทย', thaiVoices);
                createOptGroup('เสียงภาษาอื่นๆ', otherVoices);
            }
            populateVoiceList();
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = populateVoiceList;
            
            function speak(text) {
                if (synth.speaking) synth.cancel();
                if (text) {
                    utterance.text = text;
                    const selectedVoiceName = voiceSelect.selectedOptions[0]?.getAttribute('data-name');
                    utterance.voice = voices.find(voice => voice.name === selectedVoiceName);
                    utterance.pitch = pitchInput.value;
                    utterance.rate = rateInput.value;
                    synth.speak(utterance);
                }
            }
            speakButton.addEventListener('click', () => speak(textToSpeakInput.value));
            stopButton.addEventListener('click', () => synth.cancel());
            rateInput.addEventListener('input', () => rateValue.textContent = rateInput.value);
            pitchInput.addEventListener('input', () => pitchValue.textContent = pitchInput.value);

            // --- SPEECH-TO-TEXT ---
            const recognition = new SpeechRecognition();
            const listenButton = document.getElementById('listen-button');
            const listenText = document.getElementById('listen-text');
            const listeningIndicator = document.getElementById('listening-indicator');
            const transcriptOutput = document.getElementById('transcript');
            const langSelect = document.getElementById('lang-select');
            const copyButton = document.getElementById('copy-button');
            const saveSegmentButton = document.getElementById('save-segment-button');
            const saveButton = document.getElementById('save-button');
            const clearButton = document.getElementById('clear-button');
            const copyAllSegmentsButton = document.getElementById('copy-all-segments-button');
            const segmentsList = document.getElementById('segments-list');
            
            let isListening = false;
            let finalTranscript = '';
            let savedSegments = [];

            recognition.lang = langSelect.value;
            recognition.interimResults = true;
            recognition.continuous = true;

            function renderSegments() {
                segmentsList.innerHTML = '';
                if (savedSegments.length === 0) {
                    segmentsList.innerHTML = `<p class=\"text-gray-400 text-center\">ยังไม่มีช่วงที่บันทึกไว้</p>`;
                    return;
                }

                savedSegments.forEach((segment, index) => {
                    const segmentDiv = document.createElement('div');
                    segmentDiv.className = 'bg-white p-3 rounded-lg border border-gray-200';
                    segmentDiv.innerHTML = `
                        <div class=\"flex justify-between items-center mb-2\">
                            <span class=\"text-sm font-medium text-purple-700\">ช่วงที่ \${index + 1}</span>
                            <div class=\"flex space-x-2\">
                                <button class=\"copy-segment text-blue-500 hover:text-blue-700 text-sm\" data-index=\"\${index}\"><i class=\"fas fa-copy\"></i></button>
                                <button class=\"delete-segment text-red-500 hover:text-red-700 text-sm\" data-index=\"\${index}\"><i class=\"fas fa-trash\"></i></button>
                            </div>
                        </div>
                        <p class=\"text-gray-800\">\${segment}</p>
                    `;
                    segmentsList.appendChild(segmentDiv);
                });

                segmentsList.querySelectorAll('.copy-segment').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const index = e.currentTarget.dataset.index;
                        copyTextToClipboard(savedSegments[index], e.currentTarget);
                    });
                });

                segmentsList.querySelectorAll('.delete-segment').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const index = parseInt(e.currentTarget.dataset.index);
                        savedSegments.splice(index, 1);
                        renderSegments();
                    });
                });
            }

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + ' ';
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                transcriptOutput.value = finalTranscript + interimTranscript;
                transcriptOutput.scrollTop = transcriptOutput.scrollHeight;
            };

            recognition.onstart = () => {
                isListening = true;
                listenText.textContent = 'หยุดฟัง';
                listenButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                listenButton.classList.add('bg-red-600', 'hover:bg-red-700');
                listeningIndicator.classList.remove('hidden');
            };

            recognition.onend = () => {
                if (isListening) { 
                    setTimeout(() => { if (isListening) recognition.start(); }, 100);
                } else {
                    listenText.textContent = 'เริ่มฟัง';
                    listenButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    listenButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                    listeningIndicator.classList.add('hidden');
                }
            };
            
            recognition.onerror = e => console.error('Recognition Error:', e.error);

            listenButton.addEventListener('click', () => {
                isListening = !isListening;
                if (isListening) {
                    finalTranscript = transcriptOutput.value;
                    if (finalTranscript && !finalTranscript.endsWith(' ')) {
                        finalTranscript += ' ';
                    }
                    recognition.lang = langSelect.value;
                    recognition.start();
                } else {
                    recognition.stop();
                }
            });

            copyButton.addEventListener('click', (e) => copyTextToClipboard(transcriptOutput.value, e.currentTarget.querySelector('span')));
            
            clearButton.addEventListener('click', () => {
                finalTranscript = '';
                transcriptOutput.value = '';
            });

            saveButton.addEventListener('click', () => {
                const textToSave = transcriptOutput.value;
                if (textToSave) {
                    const blob = new Blob([textToSave], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'transcript.txt';
                    a.click();
                    URL.revokeObjectURL(url);
                }
            });

            saveSegmentButton.addEventListener('click', () => {
                const currentText = transcriptOutput.value.trim();
                if (currentText) {
                    savedSegments.push(currentText);
                    renderSegments();
                    finalTranscript = '';
                    transcriptOutput.value = '';
                }
            });

            copyAllSegmentsButton.addEventListener('click', (e) => {
                if (savedSegments.length > 0) {
                    const allSegmentsText = savedSegments.map((seg, i) => `--- ช่วงที่ \${i + 1} ---\\n\${seg}`).join('\\n\\n');
                    copyTextToClipboard(allSegmentsText, e.currentTarget.querySelector('span'));
                }
            });
            renderSegments();
        });
    </script>
</body>
</html>