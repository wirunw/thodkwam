<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ถอดความ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --apple-blue: #0071e3;
            --apple-gray: #555555;
            --apple-light-gray: #f5f5f7;
            --apple-text: #000000;
            --apple-secondary-text: #444444;
            --apple-accent: #0071e3;
            --apple-success: #20a13a;
            --apple-warning: #ff8c00;
            --apple-danger: #ff2d20;
        }
        
        body {
            font-family: 'Noto Sans Thai', sans-serif;
            background: #f0f4f8;
            min-height: 100vh;
            color: var(--apple-text);
        }
        
        /* Simple card styling */
        .simple-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .simple-button {
            background: white;
            border-radius: 12px;
            border: 1px solid #d1d5db;
            transition: all 0.2s;
        }
        
        .simple-button:hover {
            background: #f3f4f6;
            transform: translateY(-1px);
        }
        
        /* Custom styles for glowing dot */
        .glowing-dot {
            width: 12px;
            height: 12px;
            background-color: var(--apple-danger);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 10px var(--apple-danger);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 45, 32, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 45, 32, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 45, 32, 0); }
        }
        
        /* Clean sliders */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #d1d5db;
            border-radius: 3px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--apple-blue);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        /* Focus effects */
        textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--apple-blue);
        }
        
        .transition-all {
            transition: all 0.2s;
        }
        
        /* Apple-style loading animation */
        .loading-pulse {
            animation: loadingPulse 1s infinite ease-in-out;
        }
        
        @keyframes loadingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Segment styles */
        .segment-item {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-4xl simple-card p-6 md:p-8 space-y-8">
        
        <header class="text-center">
            <img src="https://i.postimg.cc/dDfBQVWf/wirun-facbook.png" alt="Logo ถอดความ" class="mx-auto mb-3 w-16 h-16 rounded-full object-cover shadow-md">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-2">ถอดความ</h1>
            <p class="text-gray-700 text-lg max-w-2xl mx-auto">เปลี่ยนเสียงพูดของคุณให้เป็นข้อความ และเปลี่ยนข้อความให้กลายเป็นเสียงพูดได้อย่างง่ายดายและรวดเร็ว</p>
            <div class="mt-3 bg-amber-50 border border-amber-200 text-amber-800 p-3 rounded-xl text-sm">
                <i class="fas fa-info-circle mr-2"></i>
                หมายเหตุ: แอปนี้เหมาะสำหรับใช้งานบนเดสก์ท็อปเพื่อประสิทธิภาพสูงสุด
            </div>
        </header>

        <!-- Error message for unsupported browsers -->
        <div id="unsupported-message" class="hidden bg-red-50 border border-red-200 text-red-700 p-4 rounded-xl simple-button" role="alert">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
                <p class="font-semibold">ขออภัย!</p>
            </div>
            <p class="mt-1">เบราว์เซอร์ของคุณไม่รองรับ Web Speech API โปรดลองใช้ Google Chrome หรือ Microsoft Edge เวอร์ชันล่าสุด</p>
        </div>

        <main id="app-container" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Speech-to-Text Section -->
            <div class="simple-card p-6 flex flex-col">
                <div class="flex items-center mb-4">
                    <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center mr-3">
                        <i class="fas fa-microphone text-green-600"></i>
                    </div>
                    <h2 class="text-2xl font-semibold text-gray-900">แปลงเสียงพูดเป็นข้อความ</h2>
                </div>
                
                <div class="mb-4">
                    <label for="lang-select" class="block text-sm font-medium text-gray-900 mb-2 flex items-center">
                        <i class="fas fa-globe mr-2 text-gray-700"></i>
                        เลือกภาษาที่พูด
                    </label>
                    <select id="lang-select" class="w-full p-3 bg-white border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all appearance-none cursor-pointer">
                        <option value="th-TH" selected>ภาษาไทย</option>
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="ja-JP">日本語 (ญี่ปุ่น)</option>
                        <option value="ko-KR">한국어 (เกาหลี)</option>
                        <option value="zh-CN">中文 (จีน)</option>
                    </select>
                </div>

                <div class="flex flex-col flex-grow">
                    <div class="relative flex-grow bg-white p-3 rounded-xl border border-gray-300 min-h-[180px] mb-4">
                        <textarea id="transcript" class="w-full h-full text-gray-900 bg-transparent resize focus:outline-none p-3" placeholder="ข้อความที่ถูกแปลงจะปรากฏที่นี่..."></textarea>
                        <div id="char-counter" class="absolute bottom-3 right-4 text-sm text-gray-600 flex items-center">
                            <i class="fas fa-font mr-1"></i>
                            <span>0 ตัวอักษร</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button id="listen-button" class="simple-button py-3 px-4 rounded-xl font-semibold text-green-700 border border-green-300 transition-all flex items-center justify-center gap-2">
                             <i class="fas fa-microphone"></i>
                            <span id="listen-text">เริ่มฟัง</span>
                        </button>
                        <button id="copy-button" class="simple-button py-3 px-4 rounded-xl font-semibold text-indigo-700 border border-indigo-300 transition-all flex items-center justify-center gap-2">
                           <i class="fas fa-copy"></i>
                            <span id="copy-text">คัดลอก</span>
                        </button>
                        <button id="save-segment-button" class="simple-button py-3 px-4 rounded-xl font-semibold text-purple-700 border border-purple-300 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-save"></i>
                            <span>บันทึกช่วง</span>
                        </button>
                        <button id="save-button" class="simple-button py-3 px-4 rounded-xl font-semibold text-teal-700 border border-teal-300 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-download"></i>
                            <span>บันทึก text file</span>
                        </button>
                        <button id="clear-button" class="simple-button py-3 px-4 rounded-xl font-semibold text-red-600 border border-red-300 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-trash"></i>
                            <span>ล้างข้อความ</span>
                        </button>
                        <button id="copy-all-segments" class="simple-button py-3 px-4 rounded-xl font-semibold text-indigo-600 border border-indigo-300 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-copy"></i>
                            <span>คัดลอกทุกช่วง</span>
                        </button>
                        <button id="read-aloud-button" class="col-span-2 simple-button py-3 px-4 rounded-xl font-semibold text-amber-700 border border-amber-300 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-volume-high"></i>
                            <span>อ่านออกเสียง</span>
                        </button>
                    </div>
                    
                    <div id="listening-indicator" class="hidden flex items-center justify-center gap-2 mt-4 text-red-600">
                        <div class="glowing-dot"></div>
                        <span class="font-medium">กำลังฟัง...</span>
                    </div>
                    
                    <!-- Segment container -->
                    <div id="segments-container" class="mt-4 space-y-3">
                        <h3 class="text-sm font-medium text-gray-700">ช่วงที่บันทึกไว้:</h3>
                        <div id="segments-list" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- Saved segments will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Text-to-Speech Section -->
            <div class="simple-card p-6 flex flex-col">
                <div class="flex items-center mb-4">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                        <i class="fas fa-font text-blue-600"></i>
                    </div>
                    <h2 class="text-2xl font-semibold text-gray-900">แปลงข้อความเป็นเสียงพูด</h2>
                </div>
                
                <div class="space-y-5 flex-grow">
                    <div>
                        <label for="text-to-speak" class="block text-sm font-medium text-gray-900 mb-2 flex items-center">
                            <i class="fas fa-keyboard mr-2 text-gray-700"></i>
                            ใส่ข้อความที่นี่
                        </label>
                        <textarea 
                            id="text-to-speak" 
                            rows="5" 
                            class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize"
                            placeholder="พิมพ์ข้อความภาษาไทยหรือภาษาอังกฤษ...">สวัสดีครับ ยินดีต้อนรับสู่แอปถอดความ</textarea>
                    </div>

                    <div>
                        <label for="voice-select" class="block text-sm font-medium text-gray-900 mb-2 flex items-center">
                            <i class="fas fa-user-voice mr-2 text-gray-700"></i>
                            เลือกเสียง
                        </label>
                        <select id="voice-select" class="w-full p-3 bg-white border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all appearance-none cursor-pointer">
                            <option value="">กำลังโหลดเสียง...</option>
                        </select>
                        <p class="text-sm text-gray-700 mt-2 flex items-center">
                            <i class="fas fa-info-circle mr-1"></i>
                            * รายการเสียงขึ้นอยู่กับเบราว์เซอร์และระบบปฏิบัติการของคุณ
                        </p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label for="rate" class="block text-sm font-medium text-gray-900 mb-2 flex items-center">
                                <i class="fas fa-tachometer-alt mr-2 text-gray-700"></i>
                                ความเร็ว: <span id="rate-value" class="font-bold ml-1">1.0</span>
                            </label>
                            <input type="range" id="rate" min="0.1" max="2" value="1.0" step="0.1" class="w-full">
                        </div>
                        
                        <div>
                            <label for="pitch" class="block text-sm font-medium text-gray-900 mb-2 flex items-center">
                                <i class="fas fa-volume-up mr-2 text-gray-700"></i>
                                ระดับเสียง: <span id="pitch-value" class="font-bold ml-1">1.0</span>
                            </label>
                            <input type="range" id="pitch" min="0" max="2" value="1.0" step="0.1" class="w-full">
                        </div>
                    </div>

                    <div class="flex items-center gap-4 pt-4">
                        <button id="speak-button" class="flex-grow simple-button py-3 px-4 rounded-xl font-semibold text-blue-700 border border-blue-300 hover:bg-blue-50 transition-all">
                            <i class="fas fa-play mr-2"></i>
                            พูด
                        </button>
                        <button id="stop-button" class="flex-grow simple-button py-3 px-4 rounded-xl font-semibold text-gray-700 border border-gray-300 hover:bg-gray-50 transition-all">
                            <i class="fas fa-stop mr-2"></i>
                            หยุด
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- How to Use Section -->
    <div class="w-full max-w-4xl simple-card p-6 md:p-8 mt-8">
        <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center flex items-center justify-center">
            <i class="fas fa-question-circle mr-3 text-blue-500"></i>
            วิธีการใช้งาน
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="simple-button p-5 rounded-xl border border-green-200 transition-all">
                <div class="flex items-start mb-3">
                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mr-3 flex-shrink-0">
                        <i class="fas fa-microphone text-green-600"></i>
                    </div>
                    <h4 class="font-semibold text-lg text-gray-900">🎤 แปลงเสียงพูดเป็นข้อความ</h4>
                </div>
                <ol class="list-decimal list-inside space-y-2 text-gray-800 pl-2">
                    <li>เลือกภาษาที่ต้องการพูดจากตัวเลือก</li>
                    <li>กดปุ่ม <span class="font-semibold text-green-700">'เริ่มฟัง'</span> แล้วพูด</li>
                    <li>เมื่อพูดเสร็จ สามารถ <span class="font-semibold text-amber-600">'อ่านออกเสียง'</span> เพื่อทวน</li>
                    <li>แก้ไข, <span class="font-semibold text-indigo-700">'คัดลอก'</span>, หรือ <span class="font-semibold text-teal-700">'บันทึก'</span> ข้อความ</li>
                </ol>
            </div>
            <div class="simple-button p-5 rounded-xl border border-blue-200 transition-all">
                <div class="flex items-start mb-3">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3 flex-shrink-0">
                        <i class="fas fa-font text-blue-600"></i>
                    </div>
                    <h4 class="font-semibold text-lg text-gray-900">🔊 แปลงข้อความเป็นเสียงพูด</h4>
                </div>
                <ol class="list-decimal list-inside space-y-2 text-gray-800 pl-2">
                    <li>พิมพ์ข้อความที่ต้องการในกล่องทางขวา</li>
                    <li>เลือกเสียงพูดที่ชอบจากตัวเลือก</li>
                    <li>ปรับความเร็วและระดับเสียงตามที่คุณต้องการ</li>
                    <li>กดปุ่ม <span class="font-semibold text-blue-700">'พูด'</span> เพื่อฟังเสียง</li>
                </ol>
            </div>
        </div>
    </div>


    <footer class="text-center text-gray-700 text-base py-6 mt-8">
        <div class="flex flex-col items-center">
            <img src="https://i.postimg.cc/dDfBQVWf/wirun-facbook.png" alt="Logo ถอดความ" class="mx-auto mb-3 w-10 h-10 rounded-full object-cover shadow-md">
            <p>ออกแบบโดยเภสัชกรวิรุณ เวชศิริ</p>
            <div class="flex flex-col items-center mt-2">
                <a href="http://www.pharmconnection.net" target="_blank" class="text-indigo-700 hover:text-indigo-900 transition-colors text-base mb-1">
                    <i class="fas fa-globe mr-1"></i>www.pharmconnection.net
                </a>
                <a href="https://www.linkedin.com/in/wirunw/" target="_blank" class="text-blue-700 hover:text-blue-900 transition-colors text-base">
                    <i class="fab fa-linkedin mr-1"></i>LinkedIn Profile
                </a>
            </div>
            <div class="flex space-x-4 mt-3 text-gray-600">
                <i class="fab fa-apple text-lg"></i>
                <i class="fab fa-microsoft text-lg"></i>
                <i class="fab fa-google text-lg"></i>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const synth = window.speechSynthesis;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            // Check for browser support
            if (!synth || !SpeechRecognition) {
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('unsupported-message').classList.remove('hidden');
                console.error("Web Speech API is not supported in this browser.");
                return;
            }

            // --- TEXT-TO-SPEECH ---
            const textToSpeakInput = document.getElementById('text-to-speak');
            const voiceSelect = document.getElementById('voice-select');
            const rateInput = document.getElementById('rate');
            const rateValue = document.getElementById('rate-value');
            const pitchInput = document.getElementById('pitch');
            const pitchValue = document.getElementById('pitch-value');
            const speakButton = document.getElementById('speak-button');
            const stopButton = document.getElementById('stop-button');

            let voices = [];
            const utterance = new SpeechSynthesisUtterance();

            function populateVoiceList() {
                voices = synth.getVoices();
                voiceSelect.innerHTML = '';
                
                const thaiVoices = voices.filter(voice => voice.lang.includes('th-TH'));
                const otherVoices = voices.filter(voice => !voice.lang.includes('th-TH'));

                if (thaiVoices.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = 'เสียงภาษาไทย';
                    thaiVoices.forEach(voice => {
                        const option = document.createElement('option');
                        option.textContent = `${voice.name} (${voice.lang})`;
                        option.setAttribute('data-lang', voice.lang);
                        option.setAttribute('data-name', voice.name);
                        optgroup.appendChild(option);
                    });
                    voiceSelect.appendChild(optgroup);
                    
                    // Set the first Thai voice as default if available
                    voiceSelect.selectedIndex = 1; // Skip the optgroup label
                }
                
                const otherOptgroup = document.createElement('optgroup');
                otherOptgroup.label = 'เสียงภาษาอื่นๆ';
                otherVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.setAttribute('data-lang', voice.lang);
                    option.setAttribute('data-name', voice.name);
                    otherOptgroup.appendChild(option);
                });
                voiceSelect.appendChild(otherOptgroup);
                
                // Update voice selection placeholder if no voice is selected
                if (voiceSelect.options.length === 0) {
                    voiceSelect.innerHTML = '<option value="">ไม่พบเสียงในระบบ</option>';
                } else if (voiceSelect.selectedIndex === -1) {
                    // If no Thai voices found, select the first available voice
                    voiceSelect.selectedIndex = 0;
                }
            }

            populateVoiceList();
            if (synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = populateVoiceList;
            }

            function speak() {
                if (synth.speaking) {
                    synth.cancel();
                }
                if (textToSpeakInput.value !== '') {
                    utterance.text = textToSpeakInput.value;
                    const selectedVoiceName = voiceSelect.selectedOptions[0].getAttribute('data-name');
                    utterance.voice = voices.find(voice => voice.name === selectedVoiceName);
                    utterance.pitch = parseFloat(pitchInput.value);
                    utterance.rate = parseFloat(rateInput.value);
                    synth.speak(utterance);
                }
            }
            
            speakButton.addEventListener('click', speak);
            stopButton.addEventListener('click', () => synth.cancel());
            rateInput.addEventListener('input', () => rateValue.textContent = parseFloat(rateInput.value).toFixed(1));
            pitchInput.addEventListener('input', () => pitchValue.textContent = parseFloat(pitchInput.value).toFixed(1));

            // --- SPEECH-TO-TEXT ---
            const recognition = new SpeechRecognition();
            const listenButton = document.getElementById('listen-button');
            const listenText = document.getElementById('listen-text');
            const listeningIndicator = document.getElementById('listening-indicator');
            const transcriptOutput = document.getElementById('transcript');
            const copyButton = document.getElementById('copy-button');
            const copyButtonText = document.getElementById('copy-text');
            const langSelect = document.getElementById('lang-select');
            const charCounter = document.getElementById('char-counter');
            const saveButton = document.getElementById('save-button');
            const clearButton = document.getElementById('clear-button');
            const readAloudButton = document.getElementById('read-aloud-button');

            let isListening = false;
            let finalTranscript = '';

            recognition.lang = 'th-TH'; // Set default to Thai
            recognition.interimResults = true;
            recognition.continuous = true; // Enable continuous recognition to avoid repeated permission prompts
            
            function updateCounter() {
                const count = transcriptOutput.value.length;
                charCounter.innerHTML = `<i class="fas fa-font mr-1"></i><span>${count} ตัวอักษร</span>`;
            }

            recognition.onresult = (event) => {
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                        transcriptOutput.value = finalTranscript;
                    } else {
                        // Show interim results together with final results
                        transcriptOutput.value = finalTranscript + transcript;
                    }
                }
                updateCounter();
                
                // Auto-scroll to the end to show the latest text
                transcriptOutput.scrollTop = transcriptOutput.scrollHeight;
                
                // Update the listening indicator to show activity
                if (!listeningIndicator.classList.contains('hidden')) {
                    listeningIndicator.classList.add('loading-pulse');
                    setTimeout(() => {
                        if (listeningIndicator.classList.contains('loading-pulse')) {
                            listeningIndicator.classList.remove('loading-pulse');
                        }
                    }, 500);
                }
            };

            recognition.onstart = () => {
                isListening = true;
                listenText.textContent = 'หยุดฟัง';
                listenButton.classList.remove('text-green-700', 'border-green-300', 'hover:bg-green-50');
                listenButton.classList.add('text-red-600', 'border-red-300', 'hover:bg-red-50');
                listeningIndicator.classList.remove('hidden');
            };

            recognition.onend = () => {
                // When recognition ends automatically (e.g., timeout), restart if user wants to keep listening
                if (isListening) {
                    // Try to restart immediately with the same settings to maintain microphone access
                    setTimeout(() => {
                        if (isListening) {
                            // Try to restart with a slight delay to maintain microphone access
                            recognition.lang = langSelect.value;
                            recognition.start();
                        }
                    }, 100); // Very short delay to maintain continuity
                } else {
                    // User intentionally stopped
                    listenText.textContent = 'เริ่มฟัง';
                    listenButton.classList.remove('text-red-600', 'border-red-300', 'hover:bg-red-50');
                    listenButton.classList.add('text-green-700', 'border-green-300', 'hover:bg-green-50');
                    listeningIndicator.classList.add('hidden');
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    // For 'no-speech' errors, in continuous mode we just continue
                    // The recognition will automatically continue when speech is detected
                } else if (event.error === 'audio-capture' || event.error === 'not-allowed') {
                    isListening = false;
                    listenText.textContent = 'เริ่มฟัง';
                    listenButton.classList.remove('text-red-600', 'border-red-300', 'hover:bg-red-50');
                    listenButton.classList.add('text-green-700', 'border-green-300', 'hover:bg-green-50');
                    listeningIndicator.classList.add('hidden');
                    alert('โปรดอนุญาตให้เว็บไซต์เข้าถึงไมโครโฟนของคุณ');
                } else if (event.error === 'service-not-allowed') {
                    isListening = false;
                    listenText.textContent = 'เริ่มฟัง';
                    listenButton.classList.remove('text-red-600', 'border-red-300', 'hover:bg-red-50');
                    listenButton.classList.add('text-green-700', 'border-green-300', 'hover:bg-green-50');
                    listeningIndicator.classList.add('hidden');
                    alert('บริการเสียงพูดไม่ได้รับอนุญาตในเบราว์เซอร์ของคุณ');
                }
            };

            listenButton.addEventListener('click', () => {
                if (isListening) {
                    // User manually stopping
                    isListening = false;
                    recognition.stop();
                } else {
                    // User starting
                    finalTranscript = transcriptOutput.value;
                    if (finalTranscript && !finalTranscript.endsWith(' ')) {
                        finalTranscript += ' ';
                    }
                    isListening = true;
                    recognition.lang = langSelect.value;
                    recognition.start();
                }
            });
            
            langSelect.addEventListener('change', () => {
                recognition.lang = langSelect.value;
            });

            copyButton.addEventListener('click', () => {
                if (transcriptOutput.value) {
                    transcriptOutput.select();
                    transcriptOutput.setSelectionRange(0, 99999); 
                    try {
                        document.execCommand('copy');
                        copyButtonText.textContent = 'คัดลอกแล้ว!';
                        copyButton.classList.remove('text-indigo-700', 'border-indigo-300', 'hover:bg-indigo-50');
                        copyButton.classList.add('text-green-600', 'border-green-300', 'hover:bg-green-50');
                        setTimeout(() => {
                            copyButtonText.textContent = 'คัดลอก';
                            copyButton.classList.remove('text-green-600', 'border-green-300', 'hover:bg-green-50');
                            copyButton.classList.add('text-indigo-700', 'border-indigo-300', 'hover:bg-indigo-50');
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                        alert('ไม่สามารถคัดลอกข้อความได้');
                    }
                    window.getSelection().removeAllRanges();
                }
            });

            clearButton.addEventListener('click', () => {
                finalTranscript = '';
                transcriptOutput.value = '';
                updateCounter();
                // Only reset if not currently listening
                if (!isListening) {
                    finalTranscript = '';
                }
            });

            // Segment saving functionality
            let segmentCounter = 1;
            let savedSegments = [];
            
            const saveSegmentButton = document.getElementById('save-segment-button');
            const segmentsList = document.getElementById('segments-list');
            
            saveSegmentButton.addEventListener('click', () => {
                const currentText = transcriptOutput.value;
                if (currentText.trim()) {
                    // Save the current text as a new segment
                    const newSegment = {
                        id: segmentCounter,
                        text: currentText
                    };
                    savedSegments.push(newSegment);
                    
                    // Create a new textbox for this segment
                    const segmentDiv = document.createElement('div');
                    segmentDiv.className = 'segment-item bg-gray-50 p-3 rounded-lg border border-gray-200';
                    const segmentHTML = '<div class="flex justify-between items-center mb-2">' +
                        '<span class="text-sm font-medium text-purple-700">ช่วงที่ ' + segmentCounter + '</span>' +
                        '<div class="flex space-x-2">' +
                            '<button class="copy-segment text-blue-500 hover:text-blue-700 text-sm">' +
                                '<i class="fas fa-copy"></i> คัดลอก' +
                            '</button>' +
                            '<button class="delete-segment text-red-500 hover:text-red-700 text-sm" data-id="' + segmentCounter + '">' +
                                '<i class="fas fa-trash"></i> ลบ' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="segment-content bg-white p-2 rounded border border-gray-300 min-h-[60px] max-h-40 overflow-y-auto">' +
                        currentText +
                    '</div>';
                    segmentDiv.innerHTML = segmentHTML;
                    
                    segmentsList.appendChild(segmentDiv);
                    
                    // Add event listener to the copy button
                    const copyBtn = segmentDiv.querySelector('.copy-segment');
                    copyBtn.addEventListener('click', function() {
                        const segmentText = segmentDiv.querySelector('.segment-content').textContent;
                        const tempTextarea = document.createElement('textarea');
                        tempTextarea.value = segmentText;
                        document.body.appendChild(tempTextarea);
                        tempTextarea.select();
                        tempTextarea.setSelectionRange(0, 99999);
                        
                        try {
                            document.execCommand('copy');
                            // Provide visual feedback
                            const originalText = copyBtn.innerHTML;
                            copyBtn.innerHTML = '<i class="fas fa-check"></i> คัดลอกแล้ว';
                            setTimeout(() => {
                                copyBtn.innerHTML = originalText;
                            }, 2000);
                        } catch (err) {
                            console.error('Failed to copy segment: ', err);
                            alert('ไม่สามารถคัดลอกข้อความได้');
                        }
                        
                        document.body.removeChild(tempTextarea);
                    });
                    
                    // Add event listener to the delete button
                    const deleteBtn = segmentDiv.querySelector('.delete-segment');
                    deleteBtn.addEventListener('click', function() {
                        const segmentId = parseInt(this.getAttribute('data-id'));
                        // Remove from the savedSegments array
                        savedSegments = savedSegments.filter(segment => segment.id !== segmentId);
                        // Remove the element from the DOM
                        segmentDiv.remove();
                        // Update segment numbering
                        updateSegmentNumbers();
                    });
                    
                    // Clear the main transcript textbox after saving the segment
                    transcriptOutput.value = '';
                    finalTranscript = '';
                    updateCounter();
                    
                    segmentCounter++;
                } else {
                    alert('ไม่มีข้อความให้บันทึก');
                }
            });
            
            // Function to renumber segments after deletion
            function updateSegmentNumbers() {
                const allSegments = segmentsList.querySelectorAll('.segment-item');
                // Create a new savedSegments array based on the current DOM order
                savedSegments = [];
                allSegments.forEach((segment, index) => {
                    const span = segment.querySelector('span');
                    span.textContent = `ช่วงที่ ${index + 1}`;
                    const deleteBtn = segment.querySelector('.delete-segment');
                    deleteBtn.setAttribute('data-id', index + 1);
                    // Update the segment ID and add to the new array
                    const segmentContent = segment.querySelector('.segment-content').textContent;
                    savedSegments.push({
                        id: index + 1,
                        text: segmentContent
                    });
                });
                segmentCounter = allSegments.length + 1;
            }
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    navigator.clipboard.writeText(allSegmentsText).then(() => {
                        alert('คัดลอก ' + savedSegments.length + ' ช่วงเรียบร้อยแล้ว!');
                    }).catch(err => {
                        console.error('Failed to copy segments: ', err);
                        alert('ไม่สามารถคัดลอกข้อความได้');
                    });
                } else {
                    console.error('Copy command failed');
                    alert('ไม่สามารถคัดลอกข้อความได้');
                }
            } catch (err) {
                console.error('Failed to copy segments: ', err);
                alert('ไม่สามารถคัดลอกข้อความได้');
            }
            document.body.removeChild(tempTextarea);
            });
            
            saveButton.addEventListener('click', () => {
                const textToSave = transcriptOutput.value;
                if (textToSave) {
                    const blob = new Blob([textToSave], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'ถอดความ_ทั้งหมด.txt';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            });

            readAloudButton.addEventListener('click', () => {
                if (synth.speaking) {
                    synth.cancel();
                }
                const textToRead = transcriptOutput.value;
                if (textToRead !== '') {
                    utterance.text = textToRead;
                    const selectedVoiceName = voiceSelect.selectedOptions[0].getAttribute('data-name');
                    utterance.voice = voices.find(voice => voice.name === selectedVoiceName);
                    utterance.pitch = parseFloat(pitchInput.value);
                    utterance.rate = parseFloat(rateInput.value);
                    synth.speak(utterance);
                }
            });
            
            // Add auto-scroll to text-to-speak textarea as well
            textToSpeakInput.addEventListener('input', function() {
                // Auto-scroll to the end when user types
                textToSpeakInput.scrollTop = textToSpeakInput.scrollHeight;
            });
            
            transcriptOutput.addEventListener('input', function() {
                updateCounter();
                // Auto-scroll to the end when user types
                transcriptOutput.scrollTop = transcriptOutput.scrollHeight;
            });
            updateCounter();
        });
    </script>
</body>
</html>

